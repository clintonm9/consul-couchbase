#!/bin/bash

# Consul Couchbase Server start script.

set -e

if [ "$1" = 'couchbase-server' ]
then

    if [ "$(id -u)" != "0" ]; then
        echo "This script must be run as root"
        exit 1
    fi

    # Start couchbase
    nohup /usr/local/bin/couchbase-start "$@" &

    /usr/local/bin/consul-couchbase-bootstrap

    echo "First time 'round the mulberry bush..."
    while true; do
        sleep 600
        echo "Once more 'round the mulberry bush..."
        couchbase-cli server-list -c 127.0.0.1:8091 -u $CB_USERNAME -p $CB_PASSWORD
    done
fi

exec "$@"
